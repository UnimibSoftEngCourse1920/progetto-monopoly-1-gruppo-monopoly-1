<html>
<head>
    <style>

        .column, #centro {
            float: left;
            margin-top: -6;
        }

        #div1 {
            margin-left: -6;
            background-color: #aaa;
        }

        #div2 {
            margin-right: -100;
            background-color: #aaa;
        }

        #row {
            display: none;
            margin-top: 0;
            padding: 0;
            text-align: center;
        }

        #board {
            border-style: solid;
        }
    </style>
    <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
    <script src="http://localhost:1337/client/js/Classes.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
</head>
<body>
	<div id="waitingDiv">
		waiting...
	</div>
    <div id="row">
        <div class="column" id="div1">
            <div id="p1"></div><br>
            <div id="p2"></div><br>
            <div id="p3"></div>
        </div>
        <div id="centro">
            <canvas id="board"></canvas>
        </div>
        <div class="column" id="div2">
            <div id="p4"></div><br>
            <div id="p5"></div><br>
            <div id="p6"></div>
        </div>
    </div>
<script>
	let socket, id;
  socket = io();
  socket.emit('getId');

	socket.on('id', function (data) {
        id = data.id;
        let playerName = "Player " + id;
        socket.emit('getLobby', { name: playerName });
    })

  let lobbyID;
	socket.on('setLobby', function (data) {
		lobbyID = data.lobbyID;
	})

  let players = [];
  let playersTemp = [];
  let player;
  let self;

  socket.on('startGame', function (data) {
      waitingDiv.style.display = 'none';
      row.style.display = 'block';
      createCanvas();
      playersTemp = data;
      let cont = 1;
      for (let i = 0; i < playersTemp.length; i ++) {
          player = new Player(playersTemp[i].id, playersTemp[i].name);
          players[i] = player;
          let p = "p" + cont;
          cont++;
          document.getElementById(p).innerHTML = "player: " + player.name  + " money: " + player.money;
          console.log(playersTemp[i].id + " " + playersTemp[i].name);
      }
      for (let i = 0; i < playersTemp.length; i ++) {
        players[i] = playersTemp[i];
        if (playersTemp[i].id == id)
          self = players[i];
      }
      //rifacciamo il canvas con i giocatori nella posizione 0
      paint();
  })

  let turn;
  socket.on('turn', function(data) {
    turn = data;
    if (turn == self.id)
      startTurn();
  })


  let startTurn = function() {
    let x = rolldice();

    //qui mostriamo che dado Ã¨ uscito

    socket.emit('dice', x);
    updatePosition(x);

    //gestire diverse caselle su cui si capita

    //gestire operazioni di fine turno (scambi, costruzioni..)

    //passa il turno a quello successivo
  }

  let updatePosition = function(diceNumber) {
    oldPos = self.pos;
    newPos = self.dicePos(diceNumber);
    updatePosPlayer(self, oldPos, newPos);
  }

  let rolldice = function() {
    let min = 1;
    let max = 12;
    x = Math.floor(Math.random() * (max - min) + min) + 1;
    return x;
  }

  socket.on('updatePosPlayer' function(data){
    let player = data;
    let newPos = player.pos;
    let oldPos;
    for (let i = 0; i < players.length; i ++) {
      if (players[i] != self)
        if (players[i].id == player.id) {
          oldPos = players[i].pos;
          updatePosPlayer(players[i], oldPos, newPos);
        }
    }
  })

  let updatePosPlayer = function(player, oldPos, newPos) {
    player.setPos(newPos);
    paint();
    //qui dobbiamo aggiornare la pos del player sullo schermo

  }

  let rectangleColours = [];
  let rectangles = [];
  let paint = function() {

  }

  let dpi = window.devicePixelRatio;
  let img = new Image();
  let canvas = document.getElementById("board");
  let ctx = canvas.getContext("2d");

  let createCanvas = function () {
    let H = $(window).height();
    let W = $(window).width();
    let a = (W - H) / 2;
    canvas.style.height = H - 10;
    canvas.style.width = H - 10;
    $(".column").width(a);
    fix_dpi();
    img.onload = function () {
       ctx.drawImage(img, 0, 0, canvas.width, canvas.width);
    }
    img.src = "http://localhost:1337/client/img/monopoly.png";
  }

  function fix_dpi() {
    let style_height = +getComputedStyle(canvas).getPropertyValue("height").slice(0, -2);
    let style_width = +getComputedStyle(canvas).getPropertyValue("width").slice(0, -2);
    canvas.setAttribute('height', style_height * dpi);
    canvas.setAttribute('width', style_width * dpi);
  }

</script>

</body>
</html>
